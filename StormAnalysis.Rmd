---
title: "Storm Data Analysis"
author: "Daniel Escasa"
date: "3/2/2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
# Synopsis

# Data Processing

  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First install the required libraries if needed, and load them.
```{r, loadLibs, results='hide'} 
if(!require("dplyr")) {
  install.packages("dplyr")
}
library(dplyr)

if(!require("R.utils")) {
  install.packages("R.utils")
}

if(!require("data.table")) {
  install.packages("data.table")
}
library(data.table)
if(!require("knitr")) {
  install.packages("knitr")
}
library(knitr)

if(!require("sp")) {
  install.packages("sp")
}

if(!require("numform")) {
  install.packages("numform")
}
library(numform)
```

Open the database, downloading it if it isn't in the current directory.
```{r}
if (!file.exists("StormData.bz2")) {
     message("Downloading dataset")
     download.file("http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
     destfile = "StormData.bz2", 
     method   = "internal",
     mode     = "wb")
}
```
```{r load-data, cache=TRUE}
message("Loading dataset. This could take a whileâ€¦")
stormData <- fread("StormData.bz2")
```

Function to convert the one-character PROPDMGEXP or CROPDMGEXP to
a power of ten.
```{r aux-function}
damageMultiplier <- function(xponent) {
  return(switch(toupper(xponent),
                "?" = 1,
                "1" = 1,
                "2" = 10,
                "3" = 100,
                "4" = 1e+03,
                "5" = 1e+04,
                "6" = 1e+05,
                "7" = 1e+06,
                "8" = 1e+07,
                "H" = 100,
                "K" = 1000,
                "M" = 1e+06,
                "B" = 1e+09,
                1))
}
```

Extract only the relevant columns.
```{r, extract-columns}
colsOfInterest <- stormData[, c('EVTYPE', 
                                'FATALITIES', 
                                'INJURIES', 
                                'PROPDMG', 
                                'PROPDMGEXP', 
                                'CROPDMG', 
                                'CROPDMGEXP')]
```

Create new columns for Property and Crop Damage. Also exclude rows with zero values for INJURIES, FATALITIES, PropertyDamage, *and* CropDamage.
```{r, create-new-cols}
colsOfInterest <- colsOfInterest %>%
  mutate("EVTYPE"         = toupper(trimws(EVTYPE, "b"))) %>%
  mutate("PropertyDamage" = colsOfInterest$PROPDMG * mapply(damageMultiplier, colsOfInterest$PROPDMGEXP)) %>%
  mutate("CropDamage"     = colsOfInterest$CROPDMG * mapply(damageMultiplier, colsOfInterest$CROPDMGEXP)) %>%
  subset(!(INJURIES == 0 & FATALITIES == 0 & PropertyDamage == 0 & CropDamage == 0))
```

The last line above reduces the size of the dataset from `r f_comma(dim(stormData)[1], mark = ",")` to `r f_comma(dim(colsOfInterest)[1], mark = ",")` rows.

A cursory examination of the original `StormData` dataset revealed questionable entries in the `EVTYPE` column, e.g., misspellings or leading or trailing spaces. The `trimws()` function above takes care of the latter. As to the other issues: according to the National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf), there are 48 standard Event Types. However, the dataset contains `r f_comma(length(unique(colsOfInterest$EVTYPE)), mark = ",")` unique entries.

Below is the table from the aforementioned NWS documentation:
![Storm Data Event Table](images/StormDataEventTable.png)

And here are the first 20 entries of the `EVTYPE` column with "HURRICANE" entries:
```{r}
head(colsOfInterest[grep("HURRICANE*", colsOfInterest$EVTYPE), "EVTYPE"], 20)
```

And for "HEAT" entries:
```{r}
head(colsOfInterest[grep("HEAT", colsOfInterest$EVTYPE), "EVTYPE"], 20)
```

This means the need to clean up the dataset, by modifying the `EVTYPE` entries to conform to the standard events.

Standardizing the `EVTYPE` entries in stormData entails four steps:

1. Creating a new dataset consisting of the standard event types.

1. Extracting the event types from the aforementioned PDF. The library `tabulizer` is supposed to facilitate this. Unfortunately, it wouldn't install on my R, so I had to copy-and-paste. Fortunately, the paste resulted in a single column, so it was easy to import it as a dataset.

1. Next up, get rid of the C, M, and Z designations. `gsub()` will do the job.

1. Replace the `EVTYPE`s with the standard event types.

```{r}
if (!file.exists("eventTypes.text")){
  stop("Please create file of standard Event Types")
}
```

Read in the text file and remove the designators. 
```{r, validEvents}
validEvents <- read.csv("eventTypes.text", header = F)
validEvents <- gsub(pattern = " [CMZ]$", 
                    replacement = "", 
                    x = validEvents$V1)
```

Modify the `EVTYPE` columns to conform with `validEvents`.
```{r, cleanEVTYPE}

```

Now that we have standard `EVTYPE`s, we can proceed.

# Results

Compute the total `INJURIES`, `FATALITIES`, `PropertyDamage`, and `CropDamage` per `EVTYPE`.
```{r}
allDamage <- aggregate(cbind(INJURIES, FATALITIES, PropertyDamage, CropDamage) ~ EVTYPE, 
                       colsOfInterest, sum)
```

Examine the top rows per impact type.
```{r}
head(allDamage[order(allDamage$INJURIES, decreasing = T), c("EVTYPE", "INJURIES")], 15)
head(allDamage[order(allDamage$FATALITIES, decreasing = T), c("EVTYPE", "FATALITIES")], 15)
head(allDamage[order(allDamage$PropertyDamage, decreasing = T), c("EVTYPE", "PropertyDamage")], 15)
head(allDamage[order(allDamage$CropDamage, decreasing = T), c("EVTYPE", "CropDamage")], 15)
```
```{r}
allDamage[grep("HURRICANE*", allDamage$EVTYPE), ]
```
```{r}
allDamage[grep("*SWELLS*", allDamage$EVTYPE), ]
```
